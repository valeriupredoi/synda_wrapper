<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cmip5datafinder &#8212; Cmip5DataFinderDoc  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cmip5datafinder</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/home/valeriu/sdt/bin/python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">cmip5datafinder.py</span>
<span class="sd">Python 2.7.13</span>
<span class="sd">Script that searches for data locally and on valid ESGF nodes. It builds </span>
<span class="sd">cache files using the results of the search.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#      Setup.</span>
<span class="c1"># -------------------------------------------------------------------------</span>

<span class="c1"># ---- Import standard modules to the python path.</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">getopt</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">popen2</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">loadtxt</span> <span class="k">as</span> <span class="n">lt</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">savetxt</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="k">import</span> <span class="n">minidom</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Valeriu Predoi &lt;valeriu.predoi@ncas.ac.uk&gt;&quot;</span>

<span class="c1"># ---- Function usage.</span>
<span class="c1"># ---- opts parsing</span>
<div class="viewcode-block" id="usage"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.usage">[docs]</a><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">This is a flexible tool to generate cache files from local databases and ESGF nodes.</span>
<span class="s2">This makes use of synda for querying ESGF nodes as well.</span>
<span class="s2">For problems or queries, email valeriu.predoi@ncas.ac.uk. Have fun!</span>

<span class="s2">Code functionality:</span>
<span class="s2">1. Given a command line set of arguments or an input file, the code looks for cmip5</span>
<span class="s2">files locally and returns the physical paths to the found files;</span>
<span class="s2">2. If files are not found, the user has the option to download missing files from ESGF</span>
<span class="s2">nodes via synda;</span>
<span class="s2">3. Finally, the code writes cache files stored in a directory cache_files_[SERVER]:</span>
<span class="s2">           - cache_cmip5_[SERVER].txt local cache file with paths only on server [SERVER]</span>
<span class="s2">           - cache_cmip5_combined_[SERVER].txt combined local cache file (synda+[SERVER])</span>
<span class="s2">           - cache_cmip5_synda_[SERVER].txt synda local cache file</span>
<span class="s2">           - cache_err.out errors sdout while caching</span>
<span class="s2">           - missing_cache_cmip5_[SERVER].txt local missing files on [SERVER]</span>
<span class="s2">           - missing_cache_cmip5_combined_[SERVER].txt missing files (synda+local)</span>
<span class="s2">           - missing_cache_cmip5_synda_[SERVER].txt synda missing files</span>

<span class="s2">Example run:</span>
<span class="s2">python cmip5datafinder.py -p PARAM_FILE --synda --download --dryrun --verbose --database badc</span>

<span class="s2">Definition of database:</span>
<span class="s2">To understand the output, by database we mean any file indicator</span>
<span class="s2">of form e.g. CMIP5_MIROC5_Amon_historical_r1i1p1_2003_2010_hus that is fully</span>
<span class="s2">determined by its parameters; there could be multiple .nc files</span>
<span class="s2">covering a single database, alas there could be just one.</span>
<span class="s2">All cache files contain first a file indicator = database e.g.</span>

<span class="s2">CMIP5_MIROC5_Amon_historical_r1i1p1_2003_2010_hus</span>

<span class="s2">Usage:</span>
<span class="s2">  cmip5datafinder.py [options]</span>
<span class="s2">  -p, --params-file &lt;file&gt;    Namelist file (xml) or text file (txt) or any other input file [REQUIRED] </span>
<span class="s2">                              e.g. for xml: --params-file ESMValTool/nml/namelist_myTest.xml</span>
<span class="s2">                              e.g. for text: --params-file example.txt</span>
<span class="s2">                              e.g. for yaml: --params-file example.yml</span>
<span class="s2">                              This option is REQUIRED if --user-input (command line) is NOT present</span>
<span class="s2">  -h, --help                  Display this message and exit</span>
<span class="s2">  --user-input                Flag for user defined CMIP file and variables parameters (to be input at command line</span>
<span class="s2">                              with --fileparams for each parameter)</span>
<span class="s2">                              This option is REQUIRED if --params-file is not present</span>
<span class="s2">  --database                  Name of local database (example: badc). Available databases:</span>
<span class="s2">                              badc [to add more here, depending where running the code][REQUIRED]</span>
<span class="s2">  --synda                     Flag to call synda operations. If not passed, local database will be used ONLY</span>
<span class="s2">  --download                  Flag to allow download missing data via synda</span>
<span class="s2">  --dryrun                    Flag to pass if no download is wanted. Don&#39;t pass this if downloads are neeeded!</span>
<span class="s2">                              If --dryrun in arguments, all cache files will be written as normal but with</span>
<span class="s2">                              NOT-YET-INSTALLED flag per file</span>
<span class="s2">  --fileparams                If --user-input is used, this serial option passes one data file argument at a time</span>
<span class="s2">                              If --user-input is used, this serial option is REQUIRED</span>
<span class="s2">                              e.g. --fileparams CMIP5 --fileparams MPI-ESM-LR --fileparams Amon  --fileparams historical</span>
<span class="s2">                              --fileparams r1i1p1 --fileparams 1910 --fileparams 1919</span>
<span class="s2">  --uservars                  If --user-input is used, this serial option passes one variable argument at a time</span>
<span class="s2">                              If --user-input is used, this serial option is REQUIRED</span>
<span class="s2">                              e.g. --uservars tro3</span>
<span class="s2">  --verbose                   Flag to show in-code detailed messages</span>

<span class="s2">Understand the workflow:</span>
<span class="s2">(1) python cmip5datafinder.py -p PARAM_FILE --database badc</span>
<span class="s2">   looks for files associated with databases in PARAM_FILE locally on badc only, in dirs in root /badc/cmip5/data/cmip5/output1/</span>
<span class="s2">   stores cache files in cache_files_badc/ and creates user-friendly cache cache_PARAM_FILE.txt=badc</span>
<span class="s2">(2) python cmip5datafinder.py -p PARAM_FILE --synda --database badc</span>
<span class="s2">   same as (1), but it adds the local /sdt/data/ to the data lookup targets ONLY for missing files on badc; creates combined caches </span>
<span class="s2">   with data on badc and in /sdt/;</span>
<span class="s2">   creates the same user-friendly cache_PARAM_FILE.txt=badc that this time will include files present in /sdt/ too</span>
<span class="s2">(3) python cmip5datafinder.py -p PARAM_FILE --synda --download --database badc</span>
<span class="s2">   same as (2) only this time the code will search for files that are missing from badc AND /sdt/ over the net on ESGF nodes and will</span>
<span class="s2">   download them into /sdt/data/ if no --dryrun specified; NOTE that it is impossible to ask for download if prior checks in BOTH</span>
<span class="s2">   badc and /sdt/data/ have not been done;</span>
<span class="s2">(4) python cmip5datafinder.py -p PARAM_FILE --synda --download --dryrun --database badc</span>
<span class="s2">   same as (3) but no actual downloads happen. </span>

<span class="s2">&quot;&quot;&quot;</span>
  <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">msg</span></div>

<span class="c1">########################################</span>
<span class="c1"># ---- Operational functions here ---- #</span>
<span class="c1">########################################</span>

<span class="c1"># ---- get the path to synda executable</span>
<div class="viewcode-block" id="which_synda"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.which_synda">[docs]</a><span class="k">def</span> <span class="nf">which_synda</span><span class="p">(</span><span class="n">synda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function returns the path to the synda exec</span>
<span class="sd">    or aborts the whole program if synda needs to be used</span>
<span class="sd">    but its executable is not found.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">is_exe</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">)</span>

    <span class="n">fpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">synda</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fpath</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_exe</span><span class="p">(</span><span class="n">synda</span><span class="p">):</span>
            <span class="c1">#print(&#39;We are using the following executable: %s&#39; % synda)</span>
            <span class="k">return</span> <span class="n">synda</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">exe_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">synda</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_exe</span><span class="p">(</span><span class="n">exe_file</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">exe_file</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<span class="c1"># ---- handling the years for files</span>
<div class="viewcode-block" id="time_handling"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.time_handling">[docs]</a><span class="k">def</span> <span class="nf">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">year1_model</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">year2_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is responsible for finding the correct </span>
<span class="sd">    files for the needed timespan:</span>

<span class="sd">    year1 - the start year in files</span>
<span class="sd">    year1_model - the needed start year of data</span>
<span class="sd">    year2 - the last year in files</span>
<span class="sd">    year2_model - the needed last year of data</span>
<span class="sd">    WARNINGS:</span>
<span class="sd">    we reduce our analysis only to years</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># model interval &lt; data interval / file</span>
    <span class="c1"># model requirements completely within data stretch</span>
    <span class="k">if</span> <span class="n">year1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">year2</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span><span class="kc">True</span>
    <span class="c1"># model interval &gt; data interval / file</span>
    <span class="c1"># data stretch completely within model requirements</span>
    <span class="k">elif</span> <span class="n">year1</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">year2</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
    <span class="c1"># left/right overlaps and complete misses</span>
    <span class="k">elif</span> <span class="n">year1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">year2</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
        <span class="c1"># data is entirely before model</span>
        <span class="k">if</span> <span class="n">year2</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span><span class="kc">False</span>
        <span class="c1"># data overlaps to the left</span>
        <span class="k">elif</span> <span class="n">year2</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
    <span class="k">elif</span> <span class="n">year1</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year1_model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">year2</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
        <span class="c1"># data is entirely after model</span>
        <span class="k">if</span> <span class="n">year1</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span><span class="kc">False</span>
        <span class="c1"># data overlaps to the right</span>
        <span class="k">elif</span> <span class="n">year1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year2_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span><span class="kc">False</span></div>

<span class="c1"># ---- function to handle various date formats</span>
<div class="viewcode-block" id="date_handling"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.date_handling">[docs]</a><span class="k">def</span> <span class="nf">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deals with different input date formats e.g.</span>
<span class="sd">    time1 = 198204 or</span>
<span class="sd">    time1 = 19820422 or</span>
<span class="sd">    time1 = 198204220511 etc</span>
<span class="sd">    More formats can be coded in at this stage.</span>
<span class="sd">    Returns year 1 and year 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># yyyymm</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span>
        <span class="n">year1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">.</span><span class="n">year</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time2</span><span class="p">,</span> <span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span>
        <span class="n">year2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">.</span><span class="n">year</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># yyyymmdd</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">year1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">.</span><span class="n">year</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time2</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">year2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">.</span><span class="n">year</span>
        <span class="c1"># yyyymmddHHMM</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">12</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M&#39;</span><span class="p">)</span>
            <span class="n">year1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">.</span><span class="n">year</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time2</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M&#39;</span><span class="p">)</span>
            <span class="n">year2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">.</span><span class="n">year</span>
    <span class="k">return</span> <span class="n">year1</span><span class="p">,</span><span class="n">year2</span></div>

<span class="c1"># ---- cleanup duplicate entries in files</span>
<div class="viewcode-block" id="fix_duplicate_entries"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.fix_duplicate_entries">[docs]</a><span class="k">def</span> <span class="nf">fix_duplicate_entries</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    simple fast function to eliminate duplicate entries</span>
<span class="sd">    from a cache file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ---- fixing the cache file for duplicates</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">nar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
    <span class="n">st</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">nar</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="c1"># ---- synda search</span>
<div class="viewcode-block" id="synda_search"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.synda_search">[docs]</a><span class="k">def</span> <span class="nf">synda_search</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs the database search for files</span>
<span class="sd">    It takes exactly two arguments:</span>
<span class="sd">    - a model data string of type e.g. &#39;CMIP5 MPI-ESM-LR Amon amip r1i1p1&#39;</span>
<span class="sd">    - a variable name as string e.g. &#39;tro3&#39;</span>
<span class="sd">    It performs the search for files associated with these parameters and returns ALL</span>
<span class="sd">    available files. (command example: synda search -f CMIP5 MPI-ESM-LR Amon amip r1i1p1 tro3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is needed mostly for parallel processes that may</span>
    <span class="c1"># go tits-up from time to time due to random path mixes</span>
    <span class="k">if</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No synda executable found in path. Exiting.&quot;</span>
        <span class="c1">#sys.exit(1)</span>
    <span class="n">synda_search</span> <span class="o">=</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; search -f &#39;</span> <span class="o">+</span> <span class="n">model_data</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">varname</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">synda_search</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;An error has occured while searching for data:&quot;</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err</span>
        <span class="c1">#sys.exit(1)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span></div>

<span class="c1"># ---- cache via synda</span>
<div class="viewcode-block" id="write_cache_via_synda"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.write_cache_via_synda">[docs]</a><span class="k">def</span> <span class="nf">write_cache_via_synda</span><span class="p">(</span><span class="n">searchoutput</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">year1_model</span><span class="p">,</span><span class="n">year2_model</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">outfile2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ----------------------------------------------</span>
<span class="sd">    WARNING1: this function is SLOW</span>
<span class="sd">    WARNING2: this function is not currently used</span>
<span class="sd">    ----------------------------------------------</span>
<span class="sd">    This function takes the standard search output from synda (synda_search())</span>
<span class="sd">    and parses it to see if/what files exist locally</span>

<span class="sd">    The searchoutput argument is a string and is of the form e.g.</span>

<span class="sd">    new   221.2 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_195001-195912.nc</span>
<span class="sd">    done  132.7 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_200001-200512.nc</span>
<span class="sd">    new   221.2 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_185001-185912.nc</span>
<span class="sd">    </span>
<span class="sd">    ie typical synda file search output. This gets parsed in and analyzed</span>
<span class="sd">    against the required model file characterstics and files that comply and </span>
<span class="sd">    exist locally are stored in a cache file for data reading. It also takes the year1_model and year2_model, for time checks.</span>
<span class="sd">    It also takes the variable name and the name of a cache file outfile that will be written to disk. </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is needed mostly for parallel processes that may</span>
    <span class="c1"># go tits-up from time to time due to random path mixes</span>
    <span class="k">if</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No synda executable found in path. Exiting.&quot;</span>
        <span class="c1">#sys.exit(1)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">searchoutput</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">time_range</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time2</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">year1</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year2</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">year1_model</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">year2_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">file_name_complete</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">:])</span>
                    <span class="n">true_file_name</span> <span class="o">=</span> <span class="n">file_name_complete</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">file_name_complete</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Matching file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">true_file_name</span><span class="p">)</span>
                    <span class="c1"># get the most recent file from database</span>
                    <span class="c1"># synda will always list the most recent database first</span>
                    <span class="n">synda_search</span> <span class="o">=</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; search -f -l 1 &#39;</span> <span class="o">+</span> <span class="n">true_file_name</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">synda_search</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">fc</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">file_name_complete_final</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">:])</span>
                        <span class="n">filepath_complete_0</span> <span class="o">=</span> <span class="s1">&#39;/badc/cmip5/data/c&#39;</span> <span class="o">+</span> <span class="n">file_name_complete_final</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/nc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
                        <span class="n">filepath_complete</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath_complete_0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">13</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;/latest/&#39;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath_complete_0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">14</span><span class="p">:])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">filepath_complete</span><span class="p">)</span>
                        <span class="c1"># ---- perform a local check file exists in /badc</span>
                        <span class="c1"># ---- and write cache</span>
                        <span class="n">crf</span> <span class="o">=</span> <span class="n">filepath_complete</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># ---- writing only files that match experiment type</span>
                        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">crf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath_complete</span><span class="p">):</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filepath_complete</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath_complete</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ioex</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s1">&#39;err message:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">ioex</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trying to look one directory up...&#39;</span><span class="p">)</span>
                                    <span class="n">probl</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath_complete</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="n">fnd</span> <span class="o">=</span> <span class="s1">&#39;find &#39;</span> <span class="o">+</span> <span class="n">probl</span> <span class="o">+</span>  <span class="s1">&#39; -follow -iname &quot;*.nc&quot;&#39;</span>
                                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">fnd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                                    <span class="n">prs</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                        <span class="n">ssp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                        <span class="n">av</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="c1"># --- date handling</span>
                                        <span class="n">time_range</span> <span class="o">=</span> <span class="n">av</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                                        <span class="n">time1</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">time2</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="n">year1</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">year2</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">yr1</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">yr2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                                                <span class="n">prs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found rogue file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
                                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files found...&#39;</span><span class="p">)</span>
                                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;ERROR &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">ioex</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filepath_complete</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;something went wrong with parsing the data entry, calling this a non-existent file&#39;</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;ERROR &#39;</span> <span class="o">+</span> <span class="n">file_name_complete</span> <span class="o">+</span> <span class="s1">&#39; could not be found&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Could not find database with the specified parameters on BADC&quot;</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<span class="c1"># ---- function that returns the DRS</span>
<div class="viewcode-block" id="get_drs"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.get_drs">[docs]</a><span class="k">def</span> <span class="nf">get_drs</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">sdir</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">latest_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that returns DRS.</span>
<span class="sd">    dir1: root directory - /badc/cmip5/data/cmip5/output1/</span>
<span class="sd">    sdir: subdirectory (institution) - MPI-M</span>
<span class="sd">    ic: experiment - MPI-ESM-LR</span>
<span class="sd">    model: CMIP5 MPI-ESM-LR Amon amip r1i1p1</span>
<span class="sd">    latest_dir: on badc is /latest/ - this is known in advance</span>
<span class="sd">    and is dependant on where the code is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 3h</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3h&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/3h/*/*/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
               <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="c1"># 6h</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6h&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/6h/*/*/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
               <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="c1"># daily (day)</span>
    <span class="c1"># the current implementation does not make the difference</span>
    <span class="c1"># between day and cfDay in lower dirs</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/day/*/*/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cfDay&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/cfDay/*/*/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="c1"># monthly (mon)</span>
    <span class="c1"># very detailed DRS, looking straight into variable dir</span>
    <span class="c1"># variable = model[7]</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Amon&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/atmos/Amon/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Omon&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/ocean/Omon/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lmon&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/land/Lmon/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LImon&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/landIce/LImon/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OImon&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/seaIce/OImon/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="c1"># aerosols</span>
    <span class="k">elif</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aero&#39;</span><span class="p">:</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span>\
              <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/mon/aerosol/aero/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
              <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not establish custom DRS...&#39;</span><span class="p">)</span>
        <span class="n">gdrs</span> <span class="o">=</span> <span class="n">dir1</span> <span class="o">+</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ic</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/*/*/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
               <span class="o">+</span> <span class="n">latest_dir</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using generalized path: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gdrs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gdrs</span></div>

<span class="c1"># ---- capture ls in the preferred directory</span>
<div class="viewcode-block" id="lsladir"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.lsladir">[docs]</a><span class="k">def</span> <span class="nf">lsladir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calling this function once so we save time; called in root dirname.</span>
<span class="sd">    It is needed for generalization and not hardcoding the institutions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># capture the ls output</span>
    <span class="n">lsd</span> <span class="o">=</span> <span class="s1">&#39;ls -la &#39;</span> <span class="o">+</span> <span class="n">dirname</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">lsd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span></div>

<span class="c1"># ---- local file finder</span>
<div class="viewcode-block" id="find_local_files"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.find_local_files">[docs]</a><span class="k">def</span> <span class="nf">find_local_files</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">out1</span><span class="p">,</span><span class="n">dirname1</span><span class="p">,</span><span class="n">mfile</span><span class="p">,</span><span class="n">latest_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that performs local search for files using `find&#39;</span>
<span class="sd">    The depth is as high as possible so that find is fast.</span>
<span class="sd">    model: CMIP5 MPI-ESM-LR Amon amip r1i1p1</span>
<span class="sd">    mfile: stderr dump file (cache_err.out) - need to capture</span>
<span class="sd">    instances of either Permission denied or non-existent dirs;</span>
<span class="sd">    latest_dir: latest version directory e.g. /latest/ on badc</span>
<span class="sd">    (see above for details)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">out1</span><span class="p">:</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lsd2</span> <span class="o">=</span> <span class="s1">&#39;ls -la &#39;</span> <span class="o">+</span> <span class="n">dirname1</span> <span class="o">+</span> <span class="n">subdir</span>
        <span class="n">FNULL</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">proc2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">lsd2</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">FNULL</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc2</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="c1"># work only with existing dirs or allowed permission dirs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">st2</span> <span class="ow">in</span> <span class="n">out2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">findic</span> <span class="o">=</span> <span class="n">st2</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">findic</span> <span class="o">==</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">drs</span> <span class="o">=</span> <span class="n">get_drs</span><span class="p">(</span><span class="n">dirname1</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span> <span class="n">findic</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">latest_dir</span><span class="p">)</span>
                    <span class="c1"># -follow option allows for finding symlinked files</span>
                    <span class="n">strfindic</span> <span class="o">=</span> <span class="s1">&#39;find &#39;</span> <span class="o">+</span> <span class="n">drs</span>\
                                 <span class="o">+</span><span class="s1">&#39; -follow -type f -iname &quot;*.nc&quot;&#39;</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">strfindic</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flist</span></div>
    <span class="c1"># ---- done</span>

<span class="c1"># ---- cache local data</span>
<div class="viewcode-block" id="write_cache_direct"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.write_cache_direct">[docs]</a><span class="k">def</span> <span class="nf">write_cache_direct</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">ldir</span><span class="p">,</span><span class="n">rdir</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">outfile2</span><span class="p">,</span><span class="n">errfile</span><span class="p">,</span><span class="n">ld</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that does direct parsing of available database files and establishes</span>
<span class="sd">    the paths to the needed files; makes use of find_local_files()</span>
<span class="sd">    File versioning is controlled by finding the ld = e.g. /latest/ dir </span>
<span class="sd">    in the badc database, this may differ on other clusters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">car</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># ---- eliminate duplicates from input file, if any</span>
    <span class="n">nar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">car</span><span class="p">)</span>
    <span class="n">prfile</span> <span class="o">=</span> <span class="s1">&#39;prepended_&#39;</span> <span class="o">+</span> <span class="n">params_file</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nar</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nar</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="p">(</span><span class="n">prfile</span><span class="p">,</span><span class="n">nar</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">itemlist</span> <span class="o">=</span> <span class="n">lt</span><span class="p">(</span><span class="n">prfile</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">lenitemlist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemlist</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">:</span>
        <span class="n">arname</span> <span class="o">=</span> <span class="n">find_local_files</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">ldir</span><span class="p">,</span><span class="n">rdir</span><span class="p">,</span><span class="n">errfile</span><span class="p">,</span><span class="n">ld</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>\
                         <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>\
                         <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">yr1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">yr2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">arname</span><span class="p">:</span>
                <span class="n">ssp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">av</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">time_range</span> <span class="o">=</span> <span class="n">av</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time2</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">year1</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year2</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># case where the required data completely overlaps</span>
                <span class="c1"># available data</span>
                <span class="c1"># this case stops the code to make a call to synda for this database</span>
                <span class="k">if</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">yr1</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">yr2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">yr1</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">yr2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cached file: &#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; ERROR-MISSING&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing: &#39;</span> <span class="o">+</span>  <span class="n">header</span><span class="p">)</span>
                <span class="c1"># case where the required data is not fully found</span>
                <span class="c1"># ie incomplete data </span>
                <span class="c1"># what we want to do here is cache what we have available</span>
                <span class="c1"># but also let synda know there is missing data, maybe</span>
                <span class="c1"># she can find it...just maybe</span>
                <span class="c1"># also we must make sure she doesnt download what we already have</span>
                <span class="k">if</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">yr1</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">yr2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">yr1</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">yr2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cached file: &#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
                        <span class="n">sfn</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="c1"># the INCOMPLETE indicator will be used</span>
                            <span class="c1"># to label partially complete databases so synda can</span>
                            <span class="c1"># look for the missing bits</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; INCOMPLETE &#39;</span> <span class="o">+</span> <span class="n">sfn</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; ERROR-MISSING&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing: &#39;</span> <span class="o">+</span>  <span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="c1"># missing entirely</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ERROR-MISSING&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing: &#39;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Something went wrong: could not write cache file&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile2</span><span class="p">):</span>
        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">outfile2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Looks like there are no missing files, huzzah!&quot;</span></div>

<span class="c1"># ---- print some stats</span>
<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">outfile1</span><span class="p">,</span><span class="n">outfile2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    small function to print some stats at the end</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile2</span><span class="p">):</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">outfile1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ar2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># force to a 1-liner</span>
        <span class="k">if</span> <span class="n">ar1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ar2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">###############################################################&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Found and cached: </span><span class="si">%i</span><span class="s1"> individual .nc files cached&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing/incomplete: </span><span class="si">%i</span><span class="s1"> individual datasets NOT cached/incomplete&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#################################################################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile2</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">outfile1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ar1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">########################################################&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found and cached: </span><span class="si">%i</span><span class="s1"> individual .nc files cached&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;########################################################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shoot! No cache written...something went wrong here!&#39;</span><span class="p">)</span> </div>

<span class="c1"># ---- synda download</span>
<div class="viewcode-block" id="synda_dll"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.synda_dll">[docs]</a><span class="k">def</span> <span class="nf">synda_dll</span><span class="p">(</span><span class="n">searchoutput</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">year1_model</span><span class="p">,</span><span class="n">year2_model</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">outfile2</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes the standard search output from synda</span>
<span class="sd">    and parses it to see if/what files need to be downloaded</span>

<span class="sd">    The searchoutput argument is a string and is of the form e.g.</span>

<span class="sd">    new   221.2 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_195001-195912.nc</span>
<span class="sd">    done  132.7 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_200001-200512.nc</span>
<span class="sd">    new   221.2 MB  cmip5.output1.MPI-M.MPI-ESM-LR.historical.mon.atmos.Amon.r1i1p1.v20120315.tro3_Amon_MPI-ESM-LR_historical_r1i1p1_185001-185912.nc</span>
<span class="sd">    </span>
<span class="sd">    ie typical synda file search output. This gets parsed in and analyzed</span>
<span class="sd">    against the required model file characterstics and files that comply can</span>
<span class="sd">    be downloaded via synda install. It also takes the year1_model and year2_model, for time checks.</span>
<span class="sd">    It also takes the variable name and the name of a cache file outfile that will be written to disk. </span>
<span class="sd">    dryrunOn is the switch from a physical download to just polling the esgf node without any download.</span>

<span class="sd">    varname: variable</span>
<span class="sd">    D: incomplete databases: the dictionary that contains the files that are already available locally</span>
<span class="sd">    year1_model, year2_model: needed database year1 and 2</span>
<span class="sd">    header: unique database indicator e.g. CMIP5_CNRM-CM5_Amon_historical_r1i1p1_2003_2010_hus</span>
<span class="sd">    outfile: cache file</span>
<span class="sd">    outfile2: missing cache file</span>
<span class="sd">    download: download (either dryrun or for reals) flag </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is needed mostly for parallel processes that may</span>
    <span class="c1"># go tits-up from time to time due to random path mixes</span>
    <span class="k">if</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No synda executable found in path. Exiting.&quot;</span>
        <span class="c1">#sys.exit(1)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">searchoutput</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">time_range</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time2</span> <span class="o">=</span> <span class="n">time_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">year1</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year2</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">time_handling</span><span class="p">(</span><span class="n">year1</span><span class="p">,</span> <span class="n">year1_model</span><span class="p">,</span> <span class="n">year2</span><span class="p">,</span> <span class="n">year2_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;done&#39;</span><span class="p">:</span>
                        <span class="n">file_name_complete</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">:])</span>
                        <span class="n">filepath_complete</span> <span class="o">=</span> <span class="s1">&#39;/sdt/data/c&#39;</span> <span class="o">+</span> <span class="n">file_name_complete</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/nc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
                        <span class="n">fn</span> <span class="o">=</span> <span class="n">filepath_complete</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># synda should not cache files in dictionary D</span>
                        <span class="c1"># these belong to incomplete databases but are already on disk</span>
                        <span class="k">if</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="n">header</span><span class="p">]:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filepath_complete</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;INSTALLED&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File exists: &#39;</span> <span class="o">+</span> <span class="n">filepath_complete</span><span class="p">)</span>
                                <span class="c1"># no download #</span>
                    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;new&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> doesnt exist in local /sdt/data but is on ESGF nodes, enable download to get it&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">download</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">file_name_new</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">:])</span>
                            <span class="n">filepath_new</span> <span class="o">=</span> <span class="s1">&#39;/sdt/data/c&#39;</span> <span class="o">+</span> <span class="n">file_name_new</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/nc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">filepath_new</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="c1"># synda should not download files in dictionary D</span>
                            <span class="c1"># these belong to incomplete databases but are already on disk</span>
                            <span class="k">if</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="n">header</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">dryrunOn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Download enabled in dryrun mode...&#39;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Synda found file: &#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;If installed, full path would be: &#39;</span> <span class="o">+</span> <span class="n">filepath_new</span><span class="p">)</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filepath_new</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;NOT-YET-INSTALLED&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                        <span class="c1"># no download, dryrun only #</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">synda_install</span> <span class="o">=</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="o">+</span>  <span class="s1">&#39; install &#39;</span> <span class="o">+</span> <span class="n">file_name</span>
                                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">synda_install</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">dll</span> <span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">dll</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;An error has occured while starting the download:&quot;</span>
                                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err</span>
                                        <span class="c1">#sys.exit(1)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filepath_new</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;INSTALLED&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Download enabled in full install mode...&#39;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading file: &#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Full path: &#39;</span> <span class="o">+</span> <span class="n">filepath_new</span><span class="p">)</span>
                                        <span class="c1"># yes download #</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing: &#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing: &#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="cache_merge"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.cache_merge">[docs]</a><span class="k">def</span> <span class="nf">cache_merge</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span><span class="n">file2</span><span class="p">,</span><span class="n">finalFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that takes two cache files and merges them</span>
<span class="sd">    into a single one. Caution:</span>
<span class="sd">    file1 = local database cache</span>
<span class="sd">    file2 = local synda cache</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">f2</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">r2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">r1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">finalFile</span><span class="p">):</span>
        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">finalFile</span><span class="p">)</span>                </div>
    
<span class="c1"># ---- final user-friendly cache generator</span>
<div class="viewcode-block" id="final_cache"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.final_cache">[docs]</a><span class="k">def</span> <span class="nf">final_cache</span><span class="p">(</span><span class="n">parfile</span><span class="p">,</span><span class="n">ofile1</span><span class="p">,</span><span class="n">finalfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that generates the final user-friendly</span>
<span class="sd">    single cache file; this can easily be used</span>
<span class="sd">    in various analyses; file legend:</span>
<span class="sd">    Database | data_status | Percent complete | available_data</span>
<span class="sd">    ---------------------------------------------</span>
<span class="sd">    CMIP5_MIROC5_Amon_historical_r1i1p1_2003_2010_hus (complete,incomplete or missing) [file_list, if available]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pparfile</span> <span class="o">=</span> <span class="s1">&#39;prepended_&#39;</span> <span class="o">+</span> <span class="n">parfile</span>
    <span class="n">car</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pparfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lis</span> <span class="o">=</span> <span class="n">car</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ofile1</span><span class="p">):</span>
        <span class="n">of1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ofl1</span> <span class="o">=</span> <span class="n">of1</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ofl1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lis</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>\
                     <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]</span>\
                     <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">o1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="c1"># y could be some dodgy stuff if file not proper formatted</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
                        <span class="n">yr1</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">yr2</span> <span class="o">=</span> <span class="n">date_handling</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">tt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yr1</span><span class="p">)</span>
                        <span class="n">tt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yr2</span><span class="p">)</span>
                        <span class="n">hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File: _date1-date2.nc not properly formatted...skipping it&#39;</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">])</span>
            <span class="c1"># let&#39;s see how we do with time</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># we have contiguous time</span>
                    <span class="k">if</span> <span class="n">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; complete 1.0 &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdt</span> <span class="o">=</span> <span class="n">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; incomplete &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fdt</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we have gaps</span>
                    <span class="k">if</span> <span class="n">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; complete(DATAGAPS) 1.0 &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdt</span> <span class="o">=</span> <span class="n">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; incomplete(DATAGAPS) &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fdt</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; missing&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="c1">#---- function that returns the amount of overlap</span>
<span class="c1"># between needed data and available data</span>
<div class="viewcode-block" id="get_overlap"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.get_overlap">[docs]</a><span class="k">def</span> <span class="nf">get_overlap</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">my1</span><span class="p">,</span> <span class="n">my2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function that returns the amount of overlap</span>
<span class="sd">    between needed data and available data</span>
<span class="sd">    Returns a fractional float</span>
<span class="sd">    li: list of years from data (1-dim, even number of elements)</span>
<span class="sd">    my1,my2: required model years</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
    <span class="n">my</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">my2</span> <span class="o">-</span> <span class="n">my1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># single file, no gaps in data</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my2</span><span class="p">:</span>
            <span class="c1"># completely inside</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span><span class="o">/</span><span class="n">my</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my2</span><span class="p">:</span>
            <span class="c1"># right plus</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">my2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span><span class="o">/</span><span class="n">my</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my2</span><span class="p">:</span>
            <span class="c1"># left plus</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="n">my1</span><span class="p">)</span><span class="o">/</span><span class="n">my</span>
        <span class="k">elif</span> <span class="n">my1</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">my2</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#multiple files, checking for gaps in data</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">el</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">tt</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nt</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
            <span class="c1"># multiple files, no gaps in data</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my2</span><span class="p">:</span>
                <span class="c1"># completely inside</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span><span class="o">/</span><span class="n">my</span>
            <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">my2</span><span class="p">:</span>
                <span class="c1"># right plus</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">my2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span><span class="o">/</span><span class="n">my</span>
            <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my1</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">my2</span><span class="p">:</span>
                <span class="c1"># left plus</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="n">my1</span><span class="p">)</span><span class="o">/</span><span class="n">my</span>
            <span class="k">elif</span> <span class="n">my1</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">my2</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># there are gaps!!</span>
            <span class="c1"># but we dont deal with them here</span>
            <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: there are gaps in data!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="mi">2</span></div>

        
    <span class="c1">#dtl = [tt[i] - tt[i-1] for i in range(1,nt)]</span>
    

<div class="viewcode-block" id="print_final_stats"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.print_final_stats">[docs]</a><span class="k">def</span> <span class="nf">print_final_stats</span><span class="p">(</span><span class="n">sfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print some final stats</span>
<span class="sd">    To understand the output, by database we mean any file indicator</span>
<span class="sd">    of form e.g. CMIP5_MIROC5_Amon_historical_r1i1p1_2003_2010_hus that is fully</span>
<span class="sd">    determined by its parameters; there could be multiple .nc files</span>
<span class="sd">    covering a single database, alas there could be just one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lff</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span><span class="p">]</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">]</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;missing&#39;</span><span class="p">]</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;complete(DATAGAPS)&#39;</span><span class="p">]</span>
    <span class="n">gic</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incomplete(DATAGAPS)&#39;</span><span class="p">]</span>
    <span class="n">prcc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: THERE ARE DATA GAPS!&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     Total needed databases: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">lff</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         Complete databases: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       Incomplete databases: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;          Missing databases: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">mi</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     Complete dbs with gaps: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Incomplete dbs with gaps: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gic</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Avg coverage for incomplete: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prcc</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span></div>

<span class="c1"># ---- plotting the databases in pie charts</span>
<div class="viewcode-block" id="plotter"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.plotter">[docs]</a><span class="k">def</span> <span class="nf">plotter</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span><span class="n">saveDir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    simple pie chart plotting function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get matplotlib</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># plot overall</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lff</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span><span class="p">]</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">]</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;missing&#39;</span><span class="p">]</span>
    <span class="c1"># Pie chart, where the slices will be ordered and plotted counter-clockwise:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;missing&#39;</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">mi</span><span class="p">)]</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># only &quot;explode&quot; the 2nd slice (i.e. &#39;incomplete&#39;)</span>
    <span class="c1"># plot</span>
    <span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>  <span class="c1"># Equal aspect ratio ensures that pie is drawn as a circle.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Overall data coverage&#39;</span><span class="p">)</span>
    <span class="n">saveLoc</span> <span class="o">=</span> <span class="n">saveDir</span> <span class="o">+</span> <span class="s1">&#39;/overall.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveLoc</span><span class="p">)</span>
    <span class="c1"># plot only missing</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;missing&#39;</span><span class="p">]</span>
    <span class="n">c2s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>
    <span class="c1"># Pie chart, where the slices will be ordered and plotted counter-clockwise:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">c2s</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c2s</span><span class="p">]</span>
    <span class="c1"># plot</span>
    <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>  <span class="c1"># Equal aspect ratio ensures that pie is drawn as a circle.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Missing data by model&#39;</span><span class="p">)</span>
    <span class="n">saveLoc</span> <span class="o">=</span> <span class="n">saveDir</span> <span class="o">+</span> <span class="s1">&#39;/missing.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveLoc</span><span class="p">)</span>
    <span class="c1"># plot only incomplete</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lff</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">]</span>
    <span class="n">c2s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>
    <span class="c1"># Pie chart, where the slices will be ordered and plotted counter-clockwise:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">c2s</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c2s</span><span class="p">]</span>
    <span class="c1"># plot</span>
    <span class="n">fig3</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>  <span class="c1"># Equal aspect ratio ensures that pie is drawn as a circle.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Incomplete data by model&#39;</span><span class="p">)</span>
    <span class="n">saveLoc</span> <span class="o">=</span> <span class="n">saveDir</span> <span class="o">+</span> <span class="s1">&#39;/incomplete.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveLoc</span><span class="p">)</span></div>

<span class="c1"># ---- synda check download</span>
<div class="viewcode-block" id="synda_check_dll"><a class="viewcode-back" href="../cmip5datafinder.html#cmip5datafinder.synda_check_dll">[docs]</a><span class="k">def</span> <span class="nf">synda_check_dll</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Easy checker on current downloads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Your files(s) are being downloaded.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You can check the download progress with synda queue, see output below&#39;</span><span class="p">)</span>
    <span class="n">synda_queue</span> <span class="o">=</span> <span class="s1">&#39;synda queue&#39;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">synda_queue</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">statusreport</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">statusreport</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;waiting&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> files are waiting, totalling </span><span class="si">%.2f</span><span class="s1"> MB disk&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">synda_watch</span> <span class="o">=</span> <span class="s1">&#39;synda watch&#39;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">synda_watch</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#      Parse the command line options.</span>
<span class="c1"># -------------------------------------------------------------------------</span>

<span class="c1"># ---- Initialise command line argument variables.</span>
<span class="n">params_file</span>       <span class="o">=</span> <span class="kc">None</span>
<span class="n">userVars</span>          <span class="o">=</span> <span class="kc">False</span>
<span class="n">db</span>                <span class="o">=</span> <span class="p">[]</span>
<span class="n">syndacall</span>         <span class="o">=</span> <span class="kc">False</span>
<span class="n">download</span>          <span class="o">=</span> <span class="kc">False</span>
<span class="n">dryrunOn</span>          <span class="o">=</span> <span class="kc">False</span>
<span class="n">fpars</span>             <span class="o">=</span> <span class="p">[]</span>
<span class="n">vpars</span>             <span class="o">=</span> <span class="p">[]</span>
<span class="n">verbose</span>           <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># ---- Syntax of options, as required by getopt command.</span>
<span class="c1"># ---- Short form.</span>
<span class="n">shortop</span> <span class="o">=</span> <span class="s2">&quot;h:p:b&quot;</span>
<span class="c1"># ---- Long form.</span>
<span class="n">longop</span> <span class="o">=</span> <span class="p">[</span>
   <span class="s2">&quot;help&quot;</span><span class="p">,</span>
   <span class="s2">&quot;params-file=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;user-input&quot;</span><span class="p">,</span>
   <span class="s2">&quot;database=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;synda&quot;</span><span class="p">,</span>
   <span class="s2">&quot;download&quot;</span><span class="p">,</span>
   <span class="s2">&quot;dryrun&quot;</span><span class="p">,</span>
   <span class="s2">&quot;fileparams=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;uservars=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;verbose&quot;</span>
<span class="p">]</span>

<span class="c1"># ---- Get command-line arguments.</span>
<span class="c1">#try:</span>
<span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">shortop</span><span class="p">,</span> <span class="n">longop</span><span class="p">)</span>
<span class="c1">#except getopt.GetoptError:</span>
<span class="c1">#  usage()</span>
  <span class="c1">#sys.exit(1)</span>

<span class="c1"># ---- We will record the command line arguments to cmip5datafinder.py in a file called</span>
<span class="c1">#      cmip5datafinder.param. This file should be used if a further need to run the code arises</span>
<span class="n">command_string</span> <span class="o">=</span> <span class="s1">&#39;cmip5datafinder.py &#39;</span>

<span class="c1"># ---- Parse command-line arguments.  Arguments are returned as strings, so</span>
<span class="c1">#      convert type as necessary.</span>
<span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--help&quot;</span><span class="p">):</span>
        <span class="n">usage</span><span class="p">()</span>
        <span class="c1">#sys.exit(0)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--params-file&quot;</span><span class="p">):</span>
        <span class="n">params_file</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--user-input&quot;</span><span class="p">):</span>
      <span class="n">userVars</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --user-input &#39;</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--database&quot;</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --database &#39;</span> <span class="o">+</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--synda&quot;</span><span class="p">):</span>
      <span class="n">syndacall</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --synda &#39;</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--download&quot;</span><span class="p">):</span>
      <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --download &#39;</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--dryrun&quot;</span><span class="p">):</span>
      <span class="n">dryrunOn</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --dryrun &#39;</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--fileparams&quot;</span><span class="p">):</span>
        <span class="n">fpars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --fileparams &#39;</span> <span class="o">+</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--uservars&quot;</span><span class="p">):</span>
        <span class="n">vpars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --uservars &#39;</span> <span class="o">+</span> <span class="n">a</span> 
    <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">):</span>
      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s1">&#39; --verbose &#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Unknown option:&quot;</span><span class="p">,</span> <span class="n">o</span>
        <span class="n">usage</span><span class="p">()</span>
        <span class="c1">#sys.exit(1)</span>

<span class="c1"># ---- Check that all required arguments are specified, else exit.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">params_file</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">userVars</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No parameter file specified and no user file definitions&quot;</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Use --params-file to specify the parameter file or --user-vars followed&quot;</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;by command-line options for file parameters. Exiting.&quot;</span>
        <span class="c1">#sys.exit(1)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Using the user&#39;s specified file parameters&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fpars</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;You need to specify a number of file params e.g. CMIP5,MPI-ESM-LR,Amon,historical,r1i1p1,1910,1919&quot;</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Use the --fileparams option for this&quot;</span>
           <span class="c1"># sys.exit(1)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vpars</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;You need to specify a number of variables e.g. tro3&quot;</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Use the --uservars option for this&quot;</span>
            <span class="c1">#sys.exit(1)</span>
<span class="k">if</span> <span class="n">params_file</span> <span class="ow">and</span> <span class="n">userVars</span><span class="p">:</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Use --params-file to specify the parameter file OR --user-input followed&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;by command-line options for file and variables parameters. Can not use both options! Exiting.&quot;</span>
    <span class="c1">#sys.exit(1)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No local database to search specified&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Use --database to specify a valid database e.g. badc Exiting&quot;</span>
    <span class="c1">#sys.exit(1)</span>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#      Status message.  Report all supplied arguments.</span>
<span class="c1"># -------------------------------------------------------------------------</span>

<span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">          This is a flexible tool to generate cache files from local databases and ESGF nodes.</span>
<span class="s2">          This makes use of synda for querying ESGF nodes as well.</span>
<span class="s2">          For problems or queries, email valeriu.predoi@ncas.ac.uk. Have fun!</span>
<span class="s2">          </span>
<span class="s2">          Code functionality:</span>
<span class="s2">          1. Given a command line set of arguments or an input file, the code looks for cmip5</span>
<span class="s2">          files locally and returns the physical paths to the found files;</span>
<span class="s2">          2. If files are not found, the user has the option to download missing files from ESGF</span>
<span class="s2">          nodes via synda;</span>
<span class="s2">          3. Finally, the code writes cache files:</span>
<span class="s2">           - cache_cmip5_[SERVER].txt local cache file</span>
<span class="s2">           - cache_cmip5_combined_[SERVER].txt combined cache file (synda+local)</span>
<span class="s2">           - cache_cmip5_synda_[SERVER].txt synda cache file</span>
<span class="s2">           - cache_err.out error out while caching</span>
<span class="s2">           - missing_cache_cmip5_[SERVER].txt local missing files</span>
<span class="s2">           - missing_cache_cmip5_combined_[SERVER].txt missing files (synda+local)</span>
<span class="s2">           - missing_cache_cmip5_synda_[SERVER].txt synda missing files</span>

<span class="s2">          Example run:</span>
<span class="s2">          (with param file) python cmip5datafinder.py -p perfmetrics.txt --download --dryrun --verbose --database badc</span>
<span class="s2">          (with command line args) python cmip5datafinder.py --user-input --fileparams CMIP5 --fileparams bcc-csm1-1 --fileparams --fileparams Amon</span>
<span class="s2">          --fileparams historical --fileparams r1i1p1 --fileparams 1982 --fileparams 2014 --uservars clt --uservars tro3 --uservars pr --database badc</span>
<span class="s2">          --verbose</span>
<span class="s2">          &quot;&quot;&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">intro</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;####################################################&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;#                 CMIP5 Data Finder                #&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;####################################################&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;Parsed input arguments:&quot;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">if</span> <span class="n">params_file</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Running with parameters file:&quot;</span><span class="p">,</span> <span class="n">params_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Too few file parameters (CMIP5 needs exacly 7: e.g. CMIP5 MPI-ESM-LR Amon historical r1i1p1 1980 2005)&quot;</span>
            <span class="c1">#sys.exit(1)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Running with user-defined file parameters and variables     &quot;</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;File      :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Experiment:&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Medium    :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Type      :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Ensemble  :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Year1     :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Year2     :&quot;</span><span class="p">,</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s2">&quot;Var(s)    :&quot;</span><span class="p">,</span> <span class="n">vpars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<span class="c1"># ---- if we are using synda</span>
<span class="c1"># ---- Get the synda path or exit here</span>
<span class="k">if</span> <span class="n">syndacall</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You are going to use SYNDA to download data...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Looking up synda executable...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;Synda found...OK&quot;</span> 
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No synda executable found in path. Exiting.&quot;</span>
        <span class="c1">#sys.exit(1)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># ---- Have us some information from the synda configuration file</span>
        <span class="c1"># ---- one can add more info if needed, currently just data server</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Information about synda configuration:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">synda_conf_file</span> <span class="o">=</span> <span class="n">which_synda</span><span class="p">(</span><span class="s1">&#39;synda&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/conf/sdt.conf&#39;</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Synda conf file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">synda_conf_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">synda_conf_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;indexes&#39;</span><span class="p">:</span>
                    <span class="n">data_server</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ESGF data node: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_server</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># ---- Write ASCII file holding cache_BADC.py command.</span>
<span class="n">pfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cmip5datafinder.param&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">pfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">pfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># ---- Write cache files ---- #</span>
<span class="c1"># ---- hardcoded names so we standardize analyses</span>
<span class="c1"># ---- start overall timing</span>
<span class="n">t10</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># ---- db is a list and we run on each database</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
    <span class="c1"># we need to firstly remove any pre existent cache dirs</span>
    <span class="n">drb</span> <span class="o">=</span> <span class="s1">&#39;cache_files_&#39;</span> <span class="o">+</span> <span class="n">d</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing all pre-existent cache directories...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">drb</span><span class="p">):</span>
        <span class="n">rrc</span> <span class="o">=</span> <span class="s1">&#39;rm -r &#39;</span> <span class="o">+</span> <span class="n">drb</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">rrc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Polling </span><span class="si">%s</span><span class="s1"> database...&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
    <span class="c1"># ...then create new one, standard name cache_files_[SERVER] eg cache_files_badc</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We will be writing all needed cache files to </span><span class="si">%s</span><span class="s1"> directory...&#39;</span> <span class="o">%</span> <span class="n">drb</span><span class="p">)</span>
    <span class="n">mkc</span> <span class="o">=</span> <span class="s1">&#39;mkdir -p &#39;</span> <span class="o">+</span> <span class="n">drb</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">mkc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="c1"># place the cache files</span>
    <span class="n">pfile2</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
    <span class="n">pfile3</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
    <span class="k">if</span> <span class="n">syndacall</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pfile4</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_synda_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
        <span class="n">pfile5</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_synda_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
    <span class="n">errorfile</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_err.out&#39;</span>
    <span class="k">if</span> <span class="n">params_file</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="s1">&#39;cache_&#39;</span> <span class="o">+</span> <span class="n">params_file</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="s1">&#39;cache_user.txt-&#39;</span> <span class="o">+</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>

    <span class="c1"># ---- get root directory</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%s</span><span class="s1"> as local searchable database&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;badc&#39;</span><span class="p">:</span>
        <span class="n">host_root</span> <span class="o">=</span> <span class="s1">&#39;/badc/cmip5/data/cmip5/output1/&#39;</span>
        <span class="n">ls_host_root</span> <span class="o">=</span> <span class="n">lsladir</span><span class="p">(</span><span class="n">host_root</span><span class="p">)</span>
        <span class="c1"># this is a standard for badc</span>
        <span class="n">latestDir</span> <span class="o">=</span> <span class="s1">&#39;/latest/&#39;</span>

    <span class="c1"># ---- start timer</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># ---- get the params file</span>
    <span class="k">if</span> <span class="n">params_file</span><span class="p">:</span>
        <span class="n">paramfile</span><span class="p">,</span> <span class="n">paramfile_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">params_file</span><span class="p">)</span>

        <span class="c1"># ---- txt</span>
        <span class="k">if</span> <span class="n">paramfile_extension</span><span class="o">==</span><span class="s1">&#39;.txt&#39;</span><span class="p">:</span>
            <span class="c1"># ---- Parse a generic text parameters file ---- #</span>
            <span class="c1"># ---- with the specified variable(s) ---- #</span>
            <span class="c1">##############################################################</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            NOTE: for streamlining</span>
<span class="sd">            Build a standardized .txt parameter file as follows:</span>
<span class="sd">            each row must be a standard specific file descriptor e.g.</span>
<span class="sd">            cmip  experiment type1 type2    ensemble yr1  yr2  variable</span>
<span class="sd">            ----------------------------------------------------------</span>
<span class="sd">            CMIP5 MPI-ESM-LR Amon historical r1i1p1  1900  1982   tro3 </span>
<span class="sd">    </span>
<span class="sd">            IT IS IMPORTANT TO KEEP THIS ORDER OTHERWISE THINGS CAN GET VERY MESSY !!!</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">syndacall</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># first poll the local server</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">write_cache_direct</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">write_cache_direct</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">)</span>
                <span class="c1"># check for incomplete/missing databases</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile3</span><span class="p">):</span>
                    <span class="n">ar</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">lls</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ar</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CMIP5&#39;</span><span class="p">]</span>
                    <span class="n">lenitemlist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>
                    <span class="n">cat11</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;dope&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lls</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ERROR-MISSING&#39;</span><span class="p">]</span>
                    <span class="n">cat21</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lls</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;INCOMPLETE&#39;</span><span class="p">]</span>
                    <span class="c1"># construct two dictionaries:</span>
                    <span class="c1"># A: contains all missing databases</span>
                    <span class="c1"># B: contains the incomplete databases</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat21</span><span class="p">:</span>
                        <span class="n">A</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat11</span><span class="p">:</span>
                        <span class="n">B</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># convolve A and B so synda will download only the A&#39;s &#39;dope&#39; (missing)</span>
                    <span class="c1"># and the bits from B that are not already on disk</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">**</span><span class="n">B</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We parsed a missing LOCAL data param file. We have missing/incomplete files for </span><span class="si">%i</span><span class="s1"> databases: &#39;</span> <span class="o">%</span> <span class="n">lenitemlist</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling SYNDA to look for data in /sdt/data or download what is not found...&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">lls</span><span class="p">:</span>
                        <span class="n">ite</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">ite</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">ite</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">+</span> <span class="n">ite</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">ite</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>\
                                     <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">ite</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">ite</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">yr1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ite</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="n">yr2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ite</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                        <span class="c1"># call synda search</span>
                        <span class="n">outpt</span> <span class="o">=</span> <span class="n">synda_search</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span><span class="n">v1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">download</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">dryrunOn</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">dryrunOn</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile5</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;ERROR-MISSING&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">pfile4</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">errorfile</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">errorfile</span><span class="p">)</span>
                    <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">)</span>

                    <span class="c1"># final cache merging and cleanup</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                        <span class="c1"># create a composite file using caches from sever and synda</span>
                        <span class="n">compf</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">cache_merge</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">compf</span><span class="p">)</span>
                        <span class="n">final_cache</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">compf</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">plotter</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">drb</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># looks like synda didnt find anything extra</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                            <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                            <span class="n">final_cache</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                            <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                            <span class="n">plotter</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">drb</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># looks like there is nothing in local but synda found extra</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                                <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile4</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                                <span class="n">final_cache</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                                <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                                <span class="n">plotter</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">drb</span><span class="p">)</span>
                    <span class="c1"># in case synda missed some databases</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile5</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">pfile5</span><span class="p">)</span>
                        <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile5</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no need to call synda if we found all needed databases on server</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cached all data from local database </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                        <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                        <span class="n">final_cache</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">plotter</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">drb</span><span class="p">)</span>
                    <span class="c1">#sys.exit(0)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># not calling synda at all</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have looked at existing files LOCALLY only: &#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Here is what we found:&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="n">write_cache_direct</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">write_cache_direct</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">errorfile</span><span class="p">):</span>
                    <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">errorfile</span><span class="p">)</span>
                <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                    <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                    <span class="n">final_cache</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                    <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                    <span class="n">plotter</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">drb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile3</span><span class="p">):</span>
                    <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile3</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>


    <span class="k">elif</span> <span class="n">userVars</span><span class="p">:</span>
    
        <span class="c1"># ---- user command line arguments parsed here</span>
        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">vpars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;prepended_temp.txt&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prepended_temp.txt&#39;</span><span class="p">)</span>
            <span class="c1">#if os.path.exists(&#39;temp.txt&#39;):</span>
            <span class="c1">#    os.remove(&#39;temp.txt&#39;)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>\
                     <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fpars</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fpars</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>\
                     <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vi</span>
            <span class="n">model_data</span> <span class="o">=</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>\
                     <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Looking at variable </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vi</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model data for: &#39;</span><span class="p">,</span> <span class="n">model_data</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">yr1</span> <span class="o">=</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">yr2</span> <span class="o">=</span> <span class="n">fpars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">tempfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">templine</span> <span class="o">=</span> <span class="n">model_data</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">yr1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">yr2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">vi</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">templine</span><span class="p">)</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">write_cache_direct</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_cache_direct</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">ls_host_root</span><span class="p">,</span><span class="n">host_root</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">,</span><span class="n">errorfile</span><span class="p">,</span><span class="n">latestDir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">syndacall</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We are missing files for our database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">model_data</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">yr1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">yr2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">vi</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling SYNDA to look for data in /sdt/data or download what is not found...&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="n">ar</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">lls</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ar</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CMIP5&#39;</span><span class="p">]</span>
                    <span class="n">lenitemlist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>
                    <span class="n">cat11</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;dope&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lls</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ERROR-MISSING&#39;</span><span class="p">]</span>
                    <span class="n">cat21</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lls</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;INCOMPLETE&#39;</span><span class="p">]</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat21</span><span class="p">:</span>
                        <span class="n">A</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat11</span><span class="p">:</span>
                        <span class="n">B</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">**</span><span class="n">B</span><span class="p">)</span>
                    <span class="n">outpt</span> <span class="o">=</span> <span class="n">synda_search</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span><span class="n">vi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dryrunOn</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dryrunOn</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">synda_dll</span><span class="p">(</span><span class="n">outpt</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">yr1</span><span class="p">,</span><span class="n">yr2</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">,</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dryrunOn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile5</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;ERROR-MISSING&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">pfile4</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">errorfile</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">errorfile</span><span class="p">)</span>
                    <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile4</span><span class="p">,</span><span class="n">pfile5</span><span class="p">)</span>
                    <span class="c1"># final cache merging and cleanup</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                        <span class="c1"># create a composite file using caches from sever and synda</span>
                        <span class="n">compf</span> <span class="o">=</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">cache_merge</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">compf</span><span class="p">)</span>
                        <span class="n">final_cache</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">compf</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># looks like synda didnt find anything extra</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                            <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                            <span class="n">final_cache</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                            <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># looks like there is nothing in local but synda found extra</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile4</span><span class="p">):</span>
                                <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile4</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                                <span class="n">final_cache</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">pfile4</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                                <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                    <span class="c1"># in case synda missed some databases</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile5</span><span class="p">):</span>
                        <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">pfile5</span><span class="p">)</span>
                        <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile5</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no need to call synda if we found all needed databases on server</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cached all data from local database </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                        <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                        <span class="n">final_cache</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                        <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
            <span class="c1"># not calling synda at all</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have looked at existing files LOCALLY only: &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Here is what we found:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">errorfile</span><span class="p">):</span>
                <span class="n">fix_duplicate_entries</span><span class="p">(</span><span class="n">errorfile</span><span class="p">)</span>
                <span class="n">print_stats</span><span class="p">(</span><span class="n">pfile2</span><span class="p">,</span><span class="n">pfile3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile2</span><span class="p">):</span>
                <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">final_cache</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">,</span><span class="n">pfile2</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                <span class="n">print_final_stats</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pfile3</span><span class="p">):</span>
                <span class="n">cpc</span> <span class="o">=</span> <span class="s1">&#39;cp &#39;</span> <span class="o">+</span> <span class="n">pfile3</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">drb</span> <span class="o">+</span> <span class="s1">&#39;/missing_cache_cmip5_combined_&#39;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cpc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="c1">#os.remove(&#39;temp.txt&#39;)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prepended_temp.txt&#39;</span><span class="p">)</span>

    <span class="c1"># ---- timing and exit</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=================================&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE! with database </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time elapsed: </span><span class="si">%.1f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=================================&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time elapsed: </span><span class="si">%.1f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># ---- finish, cleanup and exit</span>
<span class="k">if</span> <span class="n">params_file</span><span class="p">:</span>
    <span class="n">prp</span> <span class="o">=</span> <span class="s1">&#39;prepended_&#39;</span> <span class="o">+</span> <span class="n">params_file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prp</span><span class="p">)</span>
<span class="k">if</span> <span class="n">userVars</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp.txt&#39;</span><span class="p">)</span>
<span class="n">t20</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dt0</span> <span class="o">=</span> <span class="n">t20</span> <span class="o">-</span> <span class="n">t10</span>
<span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=================================&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE! with all databases&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time elapsed: </span><span class="si">%.1f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">dt0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=================================&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time elapsed: </span><span class="si">%.1f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">dt0</span><span class="p">)</span>

<span class="c1"># ---- end of code</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Valeriu Predoi.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>